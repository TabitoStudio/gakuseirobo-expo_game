<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" href="./img/logo.png" type="image/png" />
		<meta name="description" content="学生ロボットEXPOの試合情報ページ" />
		<title>学生ロボットEXPO　マッチ・ポータル</title>
		<link rel="stylesheet" href="./style.css" />
	</head>
	<body>
		<header class="site-header">
			<div class="container header-inner">
				<img class="logo" src="./img/logo.png" alt="学習ロボ展示会ロゴ" />
				<a class="btn official" href="https://robot.exposition.tokyo/index.html" target="_blank" rel="noopener noreferrer">
					公式ページへ
				</a>
			</div>
		</header>

		<div class="date-box">
			<div class="container">
				<p class="date-text" id="event-date">読み込み中...</p>
			</div>
		</div>

		<nav class="menu-box">
			<div class="container">
				<ul class="menu">
					<li><a href="#top" class="menu-item active" onclick="showPage('top'); return false;">TOP</a></li>
					<li><a href="#schedule" class="menu-item" id="schedule-menu-item" onclick="showPage('schedule'); return false;">試合一覧</a></li>
					<li><a href="#prezen" class="menu-item" id="prezen-menu-item" onclick="showPage('prezen'); return false;">発表一覧</a></li>
				</ul>
			</div>
		</nav>

		<section id="page-top" class="page-section page-active">
			<div id="state-message-container"></div>		
		<!-- 会場マップ -->
		<section class="venue-map-section">
			<div class="container">
				<div class="map-header-section">
					<h2 class="map-title">MAP</h2>
					<p class="map-description">気になるブースをタップして発表・試合情報を確認</p>
				</div>
				<div class="venue-map">
					<div class="map-header" onclick="window.open('https://robot.exposition.tokyo/html/participants.html', '_blank')">
						<div class="booth-label">チーム参加者ブース</div>
					</div>
					<div class="map-entrance-label">入口</div>
					<div class="map-booths">
					<div class="booth booth-large" data-sport="prezen" onclick="scrollToSport('prezen')">
						<div class="booth-label">発表</div>
						<div class="booth-badge" id="badge-prezen">0</div>
						</div>
						<div class="booth-grid">
						<div class="booth booth-small" data-sport="Soccer" onclick="scrollToSport('Soccer')">
							<div class="booth-label booth-label-small">サッカー</div>
							<div class="booth-badge booth-badge-small" id="badge-Soccer">0</div>
							</div>
							<div></div>
						<div class="booth booth-small" data-sport="rescue-line" onclick="scrollToSport('rescue-line')">
							<div class="booth-label booth-label-small">レスキュー<br>ライン</div>
							<div class="booth-badge booth-badge-small" id="badge-rescue-line">0</div>
							</div>
						<div class="booth booth-small" data-sport="rescue-maze" onclick="scrollToSport('rescue-maze')">
							<div class="booth-label booth-label-small">レスキュー<br>メイズ</div>
							<div class="booth-badge booth-badge-small" id="badge-rescue-maze">0</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
					<section class="match-info-section">
				<div class="container">
					<div id="match-info-container" class="match-info-container">
						<div class="match-loading">試合情報を読み込み中...</div>
					</div>
				</div>
			</section>
			<section class="prezen-info-section">
				<div class="container">
					<div id="prezen-info-container" class="prezen-info-container">
						<div class="match-loading">発表情報を読み込み中...</div>
					</div>
				</div>
			</section>

			<main>
				<section class="section" id="about">
					<div class="container">
						<h2>本アプリについて</h2>
						<p>
							本アプリは、学生ロボットEXPOの試合情報をリアルタイムで提供するものです。現在行われている試合や、以降の試合について調べるのにご活用ください。
						</p>
					</div>
				</section>
			</main>
		</section>

		<section id="page-schedule" class="page-section">
			<div id="schedule-state-message-container"></div>
			<div class="schedule-container">
				<div class="container">
					<h2>試合一覧</h2>
					<div id="schedule-content" class="schedule-content">
						<div class="match-loading">試合情報を読み込み中...</div>
					</div>
				</div>
			</div>
		</section>

		<section id="page-prezen" class="page-section">
			<div id="prezen-state-message-container"></div>
			<div class="schedule-container">
				<div class="container">
					<h2>発表一覧</h2>
					<div id="prezen-content" class="schedule-content">
						<div class="match-loading">発表情報を読み込み中...</div>
					</div>
				</div>
			</div>
		</section>

		<footer class="site-footer">
			<div class="container">
				<p class="muted">&copy; 2026 学生ロボットEXPO</p>
			</div>
		</footer>

		<script>
			const sportNames = {
				'Soccer': 'サッカー',
				'rescue-maze': 'レスキューメイズ',
				'rescue-line': 'レスキューライン',
				'prezen': 'フリープレゼン'
			};

			let globalData = null;

			function showPage(page) {
				if (!globalData) return;
				
				// begin/menteの時は試合一覧・発表一覧ページに遷移させない
				if ((page === 'schedule' || page === 'prezen') && (globalData.state === 'begin' || globalData.state === 'mente')) {
					return;
				}
				
				document.querySelectorAll('.page-section').forEach(el => {
					el.classList.remove('page-active');
				});
				document.getElementById(`page-${page}`).classList.add('page-active');

				document.querySelectorAll('.menu-item').forEach(el => {
					el.classList.remove('active');
				});
				event.target.classList.add('active');

				if (page === 'schedule' && globalData) {
					displaySchedulePage(globalData);
				} else if (page === 'prezen' && globalData) {
					displayPrezenPage(globalData);
				}
			}

			fetch('./data.json')
				.then(response => response.json())
				.then(data => {
					globalData = data;
					const dateElement = document.getElementById('event-date');
					dateElement.textContent = `日付: ${data.date} | 更新: ${data.update}`;
					
					updateBadgeCounts(data);
					handleStateDisplay(data);
				})
				.catch(error => {
					console.error('データの読み込みに失敗しました:', error);
					document.getElementById('event-date').textContent = '日付情報を読み込めませんでした';
				});

			function handleStateDisplay(data) {
				const stateContainer = document.getElementById('state-message-container');
				const matchInfoSection = document.querySelector('.match-info-section');
				const prezenInfoSection = document.querySelector('.prezen-info-section');
				const aboutSection = document.getElementById('about');
				const scheduleMenuItem = document.getElementById('schedule-menu-item');
				const prezenMenuItem = document.getElementById('prezen-menu-item');
				
				if (data.state === 'begin') {
					stateContainer.innerHTML = '<div class="state-message state-begin"><div class="container"><p>イベント開始までしばらくお待ちください</p></div></div>';
					matchInfoSection.style.display = 'none';
					prezenInfoSection.style.display = 'none';
					aboutSection.style.display = 'none';
					scheduleMenuItem.classList.add('disabled');
					prezenMenuItem.classList.add('disabled');
				} else if (data.state === 'mente') {
					stateContainer.innerHTML = '<div class="state-message state-mente"><div class="container"><p>現在緊急メンテナンス中です</p></div></div>';
					matchInfoSection.style.display = 'none';
					prezenInfoSection.style.display = 'none';
					aboutSection.style.display = 'none';
					scheduleMenuItem.classList.add('disabled');
					prezenMenuItem.classList.add('disabled');
				} else {
					stateContainer.innerHTML = '';
					matchInfoSection.style.display = 'block';
					prezenInfoSection.style.display = 'block';
					aboutSection.style.display = 'block';
					scheduleMenuItem.classList.remove('disabled');
					prezenMenuItem.classList.remove('disabled');
					displayAllMatchInfo(data);
					displayAllPrezenInfo(data);
				}
			}

			function displayAllMatchInfo(data) {
				const updateTime = data.update;
				const container = document.getElementById('match-info-container');
				let html = '';

				Object.keys(data).forEach(sport => {
					if (sport === 'date' || sport === 'update' || sport === 'state' || sport === 'prezen') return;
					
					const schedule = data[sport].schedule;
					const sportName = sportNames[sport] || sport;
					
					const nowMatches = schedule.filter(match => {
						return match.time <= updateTime && !match.finish;
					});
					const nowMatch = nowMatches[nowMatches.length - 1];
					
					const nextMatch = schedule.find(match => {
						return match.time > updateTime && !match.finish;
					});

					if (nowMatch || nextMatch) {
						html += `<div class="sport-section" id="sport-${sport}">
							<h3 class="sport-title">${sportName}</h3>
							<div class="match-grid">`;
						
						if (nowMatch) {
							html += generateMatchCard('Now', nowMatch, sport);
						}
						
						if (nextMatch) {
							html += generateMatchCard('Next', nextMatch, sport);
						}
						
						html += `</div></div>`;
					}
				});

				if (html === '') {
					container.innerHTML = '<div class="no-match">表示する試合情報がありません</div>';
				} else {
					container.innerHTML = html;
				}
			}

			function displayAllPrezenInfo(data) {
				const updateTime = data.update;
				const container = document.getElementById('prezen-info-container');
				
				if (!data.prezen) {
					container.innerHTML = `<div class="sport-section">
						<h3 class="sport-title">フリープレゼン</h3>
						<div class="no-match">本日の発表はありません</div>
					</div>`;
					return;
				}
				
				const schedule = data.prezen.schedule;
				let html = '';
				
				const nowPrezens = schedule.filter(prezen => {
					return prezen.time <= updateTime && !prezen.finish;
				});
				const nowPrezen = nowPrezens[nowPrezens.length - 1];
				
				const nextPrezen = schedule.find(prezen => {
					return prezen.time > updateTime && !prezen.finish;
				});
				
				html += `<div class="sport-section" id="sport-prezen">
					<h3 class="sport-title">フリープレゼン</h3>`;
				
				if (nowPrezen || nextPrezen) {
					html += `<div class="match-grid">`;
					
					if (nowPrezen) {
						html += generatePrezenCard('Now', nowPrezen);
					}
					
					if (nextPrezen) {
						html += generatePrezenCard('Next', nextPrezen);
					}
					
					html += `</div>`;
				} else {
					html += `<div class="no-match">本日の発表はありません</div>`;
				}
				
				html += `</div>`;
				
				container.innerHTML = html;
			}

			function generatePrezenCard(label, prezen) {
				const isNow = label === 'Now';
				const cardClass = isNow ? 'match-card match-card-now' : 'match-card';
				const labelClass = isNow ? 'match-label match-label-now' : 'match-label';
				let prezenHtml = `
					<div class="${cardClass}">
						<h3 class="match-title">
							<span class="${labelClass}">${label}</span>
						</h3>
						<div class="match-content">
							<div class="match-time">${prezen.time}</div>
							<div class="prezen-presenter">${prezen.name}</div>
							<div class="prezen-title">${prezen.title}</div>
							<div class="prezen-detail">${prezen.detail}</div>
						</div>
					</div>
				`;
				
				return prezenHtml;
			}

			function displaySchedulePage(data) {
				const container = document.getElementById('schedule-content');
				let html = '';

				Object.keys(data).forEach(sport => {
					if (sport === 'date' || sport === 'update' || sport === 'state' || sport === 'prezen') return;
					
					const schedule = data[sport].schedule;
					const sportName = sportNames[sport] || sport;
					
					const sortedSchedule = [...schedule].sort((a, b) => {
						return a.time.localeCompare(b.time);
					});

					html += `<div class="sport-schedule-section">
						<h3 class="sport-schedule-title">${sportName}</h3>
						<table class="schedule-table">
							<thead>
								<tr>
									<th>時間</th>
									<th>試合情報</th>
									<th>状態</th>
								</tr>
							</thead>
							<tbody>`;

					sortedSchedule.forEach(match => {
						let matchInfo = '';
						let status = '';

						if (sport === 'Soccer') {
							matchInfo = `${match.team1} <span class="vs">vs</span> ${match.team2}`;
							if (match.finish && match.score1 !== null && match.score2 !== null) {
								status = `<span class="result">${match.score1} - ${match.score2}</span>`;
							} else {
								status = match.finish ? '終了' : '予定';
							}
						} else {
							matchInfo = `${match.team} (Run ${match.run})`;
							if (match.finish && match.score !== null) {
								status = `<span class="score">${match.score}</span>`;
							} else {
								status = match.finish ? '終了' : '予定';
							}
						}

						html += `
							<tr${match.finish ? ' class="finished"' : ''}>
								<td class="time">${match.time}</td>
								<td>${matchInfo}</td>
								<td>${status}</td>
							</tr>
						`;
					});

					html += `</tbody>
						</table>
					</div>`;
				});

				container.innerHTML = html;
			}

			function displayPrezenPage(data) {
				const container = document.getElementById('prezen-content');
				
				if (!data.prezen) {
					container.innerHTML = '<div class="no-match">本日の発表はありません</div>';
					return;
				}
				
				const schedule = data.prezen.schedule;
				const sortedSchedule = [...schedule].sort((a, b) => {
					return a.time.localeCompare(b.time);
				});
				
				let html = `<div class="sport-schedule-section">
					<h3 class="sport-schedule-title">フリープレゼン</h3>
					<table class="schedule-table">
						<thead>
							<tr>
								<th>時間</th>
								<th>発表者</th>
								<th>タイトル</th>
								<th>概要</th>
								<th>状態</th>
							</tr>
						</thead>
						<tbody>`;
				
				sortedSchedule.forEach(prezen => {
					const status = prezen.finish ? '終了' : '予定';
					html += `
						<tr${prezen.finish ? ' class="finished"' : ''}>
							<td class="time">${prezen.time}</td>
							<td>${prezen.name}</td>
							<td>${prezen.title}</td>
							<td>${prezen.detail}</td>
							<td>${status}</td>
						</tr>
					`;
				});
				
				html += `</tbody>
					</table>
				</div>`;
				
				if (sortedSchedule.length === 0) {
					container.innerHTML = '<div class="no-match">本日の発表はありません</div>';
				} else {
					container.innerHTML = html;
				}
			}

			function updateBadgeCounts(data) {
				// 各競技の今日の試合数をカウント
				const counts = {
					'Soccer': 0,
					'rescue-line': 0,
					'rescue-maze': 0,
					'prezen': 0
				};

				// 試合数をカウント
				Object.keys(data).forEach(sport => {
					if (sport === 'date' || sport === 'update' || sport === 'state' || sport === 'prezen') return;
					if (data[sport] && data[sport].schedule) {
						counts[sport] = data[sport].schedule.length;
					}
				});

				// 発表数をカウント
				if (data.prezen && data.prezen.schedule) {
					counts['prezen'] = data.prezen.schedule.length;
				}

				// バッジを更新
				Object.keys(counts).forEach(sport => {
					const badge = document.getElementById(`badge-${sport}`);
					if (badge) {
						badge.textContent = counts[sport];
					}
				});
			}

			function scrollToSport(sport) {
				// データが読み込まれていない場合は何もしない
				if (!globalData) return;

				// begin/menteの時は何もしない
				if (globalData.state === 'begin' || globalData.state === 'mente') {
					return;
				}

				// TOPページを表示
				document.querySelectorAll('.page-section').forEach(el => {
					el.classList.remove('page-active');
				});
				document.getElementById('page-top').classList.add('page-active');

				document.querySelectorAll('.menu-item').forEach(el => {
					el.classList.remove('active');
				});
				document.querySelector('a[href="#top"]').classList.add('active');

				// 各競技セクションをIDで検索
				const targetSection = document.getElementById(`sport-${sport}`);

				if (targetSection) {
					// 少し遅延してからスクロール（ページ切り替えアニメーション後）
					setTimeout(() => {
						const headerOffset = 100;
						const elementPosition = targetSection.getBoundingClientRect().top;
						const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

						window.scrollTo({
							top: offsetPosition,
							behavior: 'smooth'
						});
					}, 100);
				}
			}

			function generateMatchCard(label, match, sport) {
				const isNow = label === 'Now';
				const cardClass = isNow ? 'match-card match-card-now' : 'match-card';
				const labelClass = isNow ? 'match-label match-label-now' : 'match-label';
				let matchHtml = `
					<div class="${cardClass}">
						<h3 class="match-title">
							<span class="${labelClass}">${label}</span>
						</h3>
						<div class="match-content">
							<div class="match-time">${match.time}</div>
				`;

				if (sport === 'Soccer') {
					matchHtml += `
						<div class="match-teams">
							<div class="team">${match.team1}</div>
							<div class="team-vs">vs</div>
							<div class="team">${match.team2}</div>
						</div>
					`;
				} else {
					matchHtml += `
						<div class="match-teams">
							<div class="team single-team">${match.team}</div>
						</div>
						<div class="match-run">Run ${match.run}</div>
					`;
				}

				matchHtml += `
						</div>
					</div>
				`;
				
				return matchHtml;
			}
		</script>
	</body>
</html>
